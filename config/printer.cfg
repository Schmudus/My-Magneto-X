[include magneto_device.cfg]
[include magneto_toolhead.cfg]
[include shell_command.cfg]
[include mainsail.cfg]
[include macros.cfg]
[include timelapse.cfg]
[include stepper.cfg]
[include TMC2240.cfg]
[include temperatures.cfg]
[include neopixel.cfg]
[skew_correction]
[exclude_object]
[save_variables]
filename: ~/printer_data/config/variables.cfg
  
[idle_timeout]
gcode:
    {% if printer.pause_resume.is_paused %}
        M104 S0
    {% else %}
        LM_DISABLE
        TURN_OFF_HEATERS
        M84
        M118 Idle timeout
    {% endif %}
timeout: 3600

[gcode_arcs]
resolution: 0.1

[force_move]
enable_force_move: True

#####################################################################
#	Probe
#####################################################################

[probe_eddy_current btt_eddy]
sensor_type: ldc1612
i2c_mcu: eddy
i2c_bus: i2c0f
x_offset: 0
y_offset: -33.68
z_offset: 2.39
speed: 5
lift_speed: 5
samples: 1
sample_retract_dist: 7
samples_result: average
samples_tolerance: 0.004
samples_tolerance_retries: 3
i2c_speed: 400000


#####################################################################
#	Gantry level and Mesh
#####################################################################

[quad_gantry_level]
gantry_corners:
  -94,-75
  351,428

points:
  25,25
  25,355
  288,355
  288,25

speed: 250
horizontal_move_z: 15
retries: 5
retry_tolerance: 0.0075
max_adjust: 10


[bed_mesh]
horizontal_move_z: 2
speed: 250
mesh_min: 5, 5
mesh_max: 270,321.32
probe_count: 14, 14
algorithm: bicubic
fade_start: 0.6
fade_end: 10
fade_target: 0

[safe_z_home]
home_xy_position: 165,220
z_hop: 1
z_hop_speed: 4.0
speed: 250


#####################################################################
# Heater bed
#####################################################################

[heater_bed]
heater_pin: PA1
max_power: 0.95
sensor_pin: PF3
sensor_type: Generic 3950
smooth_time: 1.0
pwm_cycle_time: 0.3
min_temp: -200
max_temp: 130
#control: pid
#pid_kp: 70.488 #63.238
#pid_ki: 0.702 #0.855
#pid_kd: 1169.116

#####################################################################
#	Extruder
#####################################################################

[extruder]
step_pin: MAG_TOOL:gpio5
dir_pin: !MAG_TOOL:gpio4
enable_pin: !MAG_TOOL:gpio10
rotation_distance: 4.637  	
microsteps: 16
full_steps_per_rotation: 200	
nozzle_diameter: 0.400
filament_diameter: 1.75
heater_pin:MAG_TOOL:gpio0
sensor_pin: MAG_TOOL:gpio26
sensor_type: magneto_adc
max_extrude_only_distance: 200.0
max_extrude_cross_section: 45.0
#adc_voltage: 3.3
pullup_resistor: 4700
min_temp:-60
max_temp: 310
max_power: 0.80
min_extrude_temp: 160
pressure_advance: 0.02
pressure_advance_smooth_time: 0.040
#control: pid
#pid_kp: 18.737 #11.745 #8.961
#pid_ki: 1.081 #0.535 #0.286
#pid_kd: 81.161 #64.473 #.276

#####################################################################
#	Verify heaters
#####################################################################

[verify_heater heater_bed]
max_error: 240
check_gain_time: 120
hysteresis: 5
heating_gain: 2

[verify_heater extruder]
max_error: 120
check_gain_time: 30
hysteresis: 5
heating_gain: 2

#####################################################################
#	Printer and board pins
#####################################################################

[printer]
kinematics: cartesian
max_velocity: 900
max_accel: 25000
max_z_velocity: 5.2
max_z_accel: 50

[board_pins]
aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,

    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=PC5

#####################################################################
#	Input shaper
#####################################################################

[input_shaper]
shaper_type_y: zv
shaper_freq_y: 30 #27.0
shaper_type_x: zv #ei
shaper_freq_x: 20 #44.4


#####################################################################
#	LLL Filament buffer
#####################################################################

[filament_switch_sensor Filament_buffer]
pause_on_runout: False
runout_gcode:
   M118 "Filament buffer empty"
event_delay: 3.0
switch_pin: ^!PG14

#####################################################################
#	Misc
#####################################################################

[gcode_button kill_switch]
pin: !PG15
press_gcode: 
    PAUSE
    M118 X or Y motion is blocked.
    M107
    M104 S0 

#####################################################################
#	5V LED
#####################################################################

[led LED]
white_pin: PD14
cycle_time: 0.010
hardware_pwm: False
initial_WHITE: 0.15


#####################################################################
#	BTT EDDY
#####################################################################

[gcode_macro G28]
rename_existing: G28.1
gcode:
  status_homing
  LM_ENABLE
  {% if not 'Z' in params and not 'Y' in params and 'X' in params %}
    G28.1 X
    _CLIENT_LINEAR_MOVE X=100 F=9000
  {% elif not 'Z' in params and not 'X' in params and 'Y' in params %}
    G28.1 Y
    _CLIENT_LINEAR_MOVE Y=100 F=9000
  {% elif not 'Z' in params and 'X' in params and 'Y' in params %}
    G28.1 X
    _CLIENT_LINEAR_MOVE X=100 F=9000
    G28.1 Y
    _CLIENT_LINEAR_MOVE Y=100 F=9000
  {% elif not 'X' in params and not 'Y' in params and 'Z' in params %}
    G28.1 Z
#    PROBE
#    SET_Z_FROM_PROBE
    G1 Z10 F312
  {% else %}
    G90
    G28.1 X
    _CLIENT_LINEAR_MOVE X=100 F=9000
    M400
    G28.1 Y
    _CLIENT_LINEAR_MOVE Y=100 F=9000
    M400
    G28.1 Z
  {% endif %}
  M400
  G1 Z10 F312
  status_ready

[gcode_macro SET_Z_FROM_PROBE]
gcode:
    {% set cf = printer.configfile.settings %}
    SET_GCODE_OFFSET_ORIG Z={printer.probe.last_z_result - cf['probe_eddy_current btt_eddy'].z_offset + printer["gcode_macro SET_GCODE_OFFSET"].runtime_offset}
    G90
    G1 Z{cf.safe_z_home.z_hop}

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [skew_correction calilantern_skew_profile]
#*# xy_skew = 0.0039881582549344255
#*# xz_skew = -0.005345846171373306
#*# yz_skew = 0.002043567964383297
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 70.0
#*# pid_ki = 0.7
#*# pid_kd = 1169.0
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 9.890
#*# pid_ki = 0.956
#*# pid_kd = 225.557
#*#
#*# [probe_eddy_current btt_eddy]
#*# reg_drive_current = 15
#*# calibrate =
#*# 	0.050000:3182328.299,0.090000:3181664.206,0.130000:3180995.917,
#*# 	0.170000:3180310.441,0.210000:3179637.905,0.250000:3178968.547,
#*# 	0.290000:3178298.295,0.330000:3177667.871,0.370000:3177008.123,
#*# 	0.410000:3176433.349,0.450000:3175807.031,0.490000:3175240.159,
#*# 	0.530000:3174641.186,0.570000:3174045.909,0.610000:3173466.610,
#*# 	0.650000:3172872.925,0.690000:3172329.260,0.730000:3171783.212,
#*# 	0.770000:3171243.459,0.810000:3170658.088,0.850000:3170158.038,
#*# 	0.890000:3169636.660,0.930000:3169138.014,0.970000:3168613.801,
#*# 	1.010000:3168137.244,1.050000:3167641.353,1.090000:3167158.535,
#*# 	1.130000:3166680.489,1.170000:3166220.366,1.210000:3165780.582,
#*# 	1.250000:3165323.292,1.290000:3164894.881,1.330000:3164458.010,
#*# 	1.370000:3164004.197,1.410000:3163584.527,1.450000:3163168.718,
#*# 	1.490000:3162761.226,1.530000:3162350.237,1.570000:3161965.822,
#*# 	1.610000:3161572.997,1.650000:3161185.173,1.690000:3160815.664,
#*# 	1.730000:3160472.147,1.770000:3160076.637,1.810000:3159738.681,
#*# 	1.850000:3159385.255,1.890000:3159049.075,1.930000:3158700.170,
#*# 	1.970000:3158397.885,2.010000:3158012.320,2.050000:3157716.286,
#*# 	2.090000:3157407.753,2.130000:3157110.812,2.170000:3156790.543,
#*# 	2.210000:3156489.960,2.250000:3156202.478,2.290000:3155894.526,
#*# 	2.330000:3155629.750,2.370000:3155329.943,2.410000:3155051.851,
#*# 	2.450000:3154759.414,2.490000:3154524.470,2.530000:3154245.827,
#*# 	2.570000:3153977.444,2.610000:3153737.871,2.650000:3153480.679,
#*# 	2.690000:3153226.111,2.730000:3152944.499,2.770000:3152737.008,
#*# 	2.810000:3152510.662,2.850000:3152257.814,2.890000:3152016.705,
#*# 	2.930000:3151788.982,2.970000:3151576.701,3.010000:3151343.438,
#*# 	3.050000:3151143.009,3.090000:3150946.523,3.130000:3150718.871,
#*# 	3.170000:3150512.502,3.210000:3150312.806,3.250000:3150101.990,
#*# 	3.290000:3149918.940,3.330000:3149764.366,3.370000:3149545.977,
#*# 	3.410000:3149376.325,3.450000:3149173.656,3.490000:3149014.469,
#*# 	3.530000:3148791.885,3.570000:3148642.018,3.610000:3148464.314,
#*# 	3.650000:3148298.217,3.690000:3148135.100,3.730000:3147963.841,
#*# 	3.770000:3147802.650,3.810000:3147666.348,3.850000:3147489.279,
#*# 	3.890000:3147321.171,3.930000:3147200.078,3.970000:3147027.120,
#*# 	4.010000:3146867.240,4.050000:3146716.265
#*#
#*# [temperature_probe btt_eddy]
#*# calibration_temp = 44.939639
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.034946, 0.026407, 0.033816, 0.028088, 0.033367, 0.030427, 0.036757, 0.026616, 0.024308, 0.016123, 0.011930, 0.018856, 0.018013, 0.024100
#*# 	0.036757, 0.032005, 0.029139, 0.032236, 0.032236, 0.043088, 0.030650, 0.029346, 0.015917, 0.007104, 0.009624, 0.006476, 0.005427, 0.010673
#*# 	0.051462, 0.037213, 0.041958, 0.030658, 0.032911, 0.039692, 0.031781, 0.022210, 0.010882, 0.005636, 0.006476, 0.003329, -0.002758, -0.001709
#*# 	0.039929, 0.036083, 0.024726, 0.030650, 0.024940, 0.026616, 0.029346, 0.012697, 0.007734, 0.004378, 0.001230, -0.004016, -0.001918, 0.001230
#*# 	0.051686, 0.036759, 0.029555, 0.026616, 0.030426, 0.030426, 0.020111, 0.019137, 0.009624, 0.001230, -0.001709, -0.005698, -0.006324, -0.014949
#*# 	0.036301, 0.029346, 0.017172, 0.022210, 0.017172, 0.019412, 0.014026, 0.013821, -0.000660, -0.002758, -0.005906, -0.010108, -0.005487, -0.008428
#*# 	0.038343, 0.022210, 0.020111, 0.016123, 0.020952, 0.016966, 0.009833, 0.008575, 0.006268, -0.007164, -0.007164, -0.016267, -0.019572, -0.020890
#*# 	0.016124, 0.007943, 0.011930, 0.015218, 0.009833, 0.008784, 0.007734, 0.007317, -0.001918, -0.014949, -0.013483, -0.016267, -0.025069, -0.022425
#*# 	0.029346, 0.018856, 0.013820, 0.013821, 0.016759, 0.009623, 0.011514, 0.001021, 0.002279, -0.007373, -0.012969, -0.021326, -0.023743, -0.031019
#*# 	0.023260, 0.011088, 0.007943, 0.015917, 0.011930, 0.015917, 0.011721, 0.013611, 0.005427, -0.008213, -0.020227, -0.015167, -0.017147, -0.027484
#*# 	0.021160, 0.005636, 0.011723, 0.025149, 0.028297, 0.023050, 0.015917, 0.023259, 0.022210, -0.004857, -0.006115, -0.015167, -0.012969, -0.013188
#*# 	0.009624, 0.006476, 0.013821, 0.025357, 0.030426, 0.033591, 0.028927, 0.017172, 0.018856, 0.002279, 0.002279, -0.005906, -0.002967, -0.014068
#*# 	0.016965, 0.015218, 0.019062, 0.027247, 0.032686, 0.029763, 0.030650, 0.026616, 0.021369, 0.013820, 0.014869, 0.012563, 0.003329, -0.001918
#*# 	0.018014, 0.019062, 0.025149, 0.031106, 0.039400, 0.047166, 0.051455, 0.043988, 0.036532, 0.026407, 0.034497, 0.016965, 0.016123, 0.011088
#*# x_count = 14
#*# y_count = 14
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 15.0
#*# max_x = 269.93
#*# min_y = 15.0
#*# max_y = 321.28000000000003
